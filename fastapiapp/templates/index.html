<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GIS OPPGAVE</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
   <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div id="test-controls">
    <button onclick="AreaLayer.Toggle()">Toggle areas</button>
    <button onclick="HeightMapLayer.Toggle()">Toggle heightmap</button>
  </div>
  <div id="map"></div>
  
    
  
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script src="/static/app.js"></script>
  <script src="/static/js/WmsLayer.js"></script>
  <script src="/static/js/WfsLayer.js"></script>
  <script src="/static/js/BunkerLoader.js"></script>
  <script src="/static/js/RouteManager.js"></script>
  


  
  <script>
	function proxyize(url) {
		return 'proxy?url=' + encodeURIComponent(url);
	}	
  var RIP = false;
  
	var wfsUrl = proxyize("https://wfs.geonorge.no/skwms1/wfs.tilfluktsrom_offentlige?SERVICE=WFS&VERSION=2.0.0&REQUEST=GetFeature&TYPENAMES=app:Tilfluktsrom")
	const b = new BunkerLoader(map, wfsUrl);
	b.LoadFromServer();
	
	window.onload = () => {
		map.setZoom(14)
		map.panTo([58.505, 8.59])
	}

  var marker = L.marker([58.505, 8.59]).addTo(map);

  const AreaLayer = new WmsLayer(map, "https://wms.geonorge.no/skwms1/wms.arealbruk");
  const HeightMapLayer = new WmsLayer(map,'https://wms.geonorge.no/skwms1/wms.hoyde-dtm-lokal-hoyde-farge');

  _Routes = []
  map.on('click', async function(e) {
    if (RIP == true) {
      alert("ROUTING IN PROGRESS")
      throw "Routing in progress";
    }
    RM = new RouteManager(map);
    RIP = true;
    // e.latlng is a Leaflet LatLng object
    const lat = e.latlng.lat;
    const lon = e.latlng.lng;

    console.log("Clicked position:", lat, lon);
    const mrk = L.marker([lat,lon]).addTo(map);
    closest_bunker = b.ClosestBunker(lat,lon);
    // Example: call your RouteToNearestBunker function
    try {
      start_cords = [lat,lon];
      end_cords = [closest_bunker["geometry"].coordinates[1], closest_bunker["geometry"].coordinates[0]];
      await RM.FetchRoute(start_cords,end_cords)
      _Routes.push(RM);

    } catch (e) {
      RIP = false;
      alert('Route failed to routize ' + e)
    }
    
    RIP = false;
  });

  </script>
</body>
</html>